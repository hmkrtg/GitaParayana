<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gita — One Verse</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
<style>
 :root{
  /* Midnight + temple gold palette */
  --bg:#050815; --fg:#eef3ff; --muted:#a8b2db; --card:#0c122e; --border:#1a2555;
  --gold:#ffd66b; --gold2:#ffb83f; --aqua:#7fb6ff; --vio:#9a7bff;
  --btn:#111a45; --btn-border:#243070; --shadow:0 26px 70px rgba(0,0,0,.6);
  --skt-size: 2rem; --trl-size: 1.08rem; --body-size: 1.08rem;
}

/* ===== BACKGROUND: starfield + aurora sweep ===== */
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
html,body{height:100%}
body{
  font-family: Inter, system-ui, sans-serif; color:var(--fg); margin:0;
  background:
    /* big aurora blobs */
    radial-gradient(1200px 600px at 50% -380px, rgba(255,214,107,.14), transparent 60%),
    radial-gradient(900px 500px at 8% 120%, rgba(127,182,255,.12), transparent 60%),
    radial-gradient(700px 400px at 92% 120%, rgba(154,123,255,.10), transparent 60%),
    #050815;
  overflow-x:hidden; position:relative; isolation:isolate;
}
body::before, body::after{
  /* layered starfields */
  content:""; position:fixed; inset:-10%; z-index:-2; pointer-events:none;
  background:
    radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.9) 40%, transparent 41%),
    radial-gradient(1.5px 1.5px at 70% 60%, rgba(255,255,255,.7) 40%, transparent 41%),
    radial-gradient(1.8px 1.8px at 40% 80%, rgba(255,255,255,.8) 40%, transparent 41%),
    radial-gradient(1.2px 1.2px at 85% 25%, rgba(255,255,255,.6) 40%, transparent 41%),
    radial-gradient(1.6px 1.6px at 10% 70%, rgba(255,255,255,.75) 40%, transparent 41%),
    transparent;
  animation: drift1 120s linear infinite;
  opacity:.55;
  filter: drop-shadow(0 0 3px rgba(255,255,255,.35));
}
body::after{
  transform: scale(1.4);
  animation: drift2 160s linear infinite reverse;
  opacity:.35;
}
@keyframes drift1 { to { transform: translate3d(-6%, -4%, 0) } }
@keyframes drift2 { to { transform: translate3d(6%, 4%, 0) } }

/* slow conic sweep glow */
body::marker, body:focus{ outline:none }
body > .wrap::before{
  content:""; position:fixed; inset:-30%; z-index:-1; pointer-events:none;
  background: conic-gradient(from 120deg at 50% 50%, rgba(255,214,107,.18), rgba(127,182,255,.12), transparent 30%);
  mix-blend-mode: screen; filter: blur(70px); opacity:.35;
  animation: sweep 22s linear infinite;
}
@keyframes sweep { to { transform: rotate(360deg) } }
@media (prefers-reduced-motion: reduce){ body::before, body::after, .wrap::before { animation: none } }

.wrap{ max-width: 960px; margin: 16px auto; padding: 0 14px 86px }

/* ===== HEADER ===== */
header{ display:flex; align-items:center; justify-content:space-between; margin:6px 0 12px }
.title{ font-weight:900; letter-spacing:.35px; font-size:1.22rem;
  background: linear-gradient(90deg, var(--gold), #fff);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  filter: drop-shadow(0 2px 10px rgba(255,214,107,.25));
}

/* ===== CONTROL BAR (glassy, neon edges) ===== */
.bar{
  display:flex; flex-wrap:wrap; gap:.65rem; align-items:center;
  padding:12px; border-radius:18px; border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(18,26,63,.85), rgba(10,14,34,.78));
  box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,.06), 0 0 0 1px rgba(122,162,255,.12);
  position:sticky; top:8px; z-index:10; backdrop-filter: blur(12px);
}
label{ display:flex; align-items:center; gap:.5rem; color:var(--muted); font-size:1rem }
input, select{
  padding:.78rem .9rem; border-radius:14px; border:1px solid var(--btn-border);
  background: linear-gradient(180deg, var(--btn), #0a1132);
  color:var(--fg); font-size:1rem; min-height:48px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
input[type=number]{ width:5.4rem }
button{
  padding:.82rem 1.15rem; border-radius:14px; border:1px solid var(--btn-border);
  background: linear-gradient(180deg, var(--btn), #0a1132);
  color:var(--fg); cursor:pointer; font-size:1rem; min-height:48px;
  transition: transform .08s ease, box-shadow .25s ease, filter .25s;
  box-shadow: 0 0 0 rgba(0,0,0,0);
}
button:hover{ transform: translateY(-1px); filter: brightness(1.06) }
button:active{ transform: translateY(0) scale(.98) }
button:focus-visible, input:focus-visible, select:focus-visible{
  outline:2px solid var(--aqua); outline-offset:2px;
}
.accent{
  background: radial-gradient(80% 140% at 50% 0%, #fff2b0, var(--gold));
  color:#2b2100; border:0; font-weight:900; letter-spacing:.25px;
  box-shadow: 0 12px 26px rgba(255,203,78,.38), 0 0 0 1px rgba(255,203,78,.35) inset;
  animation: pulse 2.2s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{ box-shadow: 0 12px 26px rgba(255,203,78,.32), 0 0 0 1px rgba(255,203,78,.32) inset }
  50%{ box-shadow: 0 18px 36px rgba(255,203,78,.55), 0 0 0 1px rgba(255,203,78,.45) inset }
}
.status{ color:var(--muted); font-size:.95rem; margin-left:auto }

/* ===== VERSE CARD (halo + sheen) ===== */
.card{
  position:relative; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)), var(--card);
  border:1px solid var(--border); border-radius:22px; padding:24px 20px;
  box-shadow: var(--shadow);
  overflow:hidden;
}
.card::before{
  /* halo behind verse */
  content:""; position:absolute; inset:-2px; z-index:0; border-radius:24px;
  background: radial-gradient(420px 260px at 50% 6%, rgba(255,214,107,.20), transparent 60%);
  filter: blur(12px);
}

h2{ margin:0 0 18px; font-size:1.04rem; font-weight:900; color:var(--muted); position:relative; z-index:2 }

.section{ margin-top:16px; position:relative; z-index:2; animation: rise .3s ease }
@keyframes rise{ from{ opacity:0; transform: translateY(8px) } to{ opacity:1; transform:none } }

/* DRAMATIC VERSE */
.skt{
  font-family:"Noto Serif Devanagari", serif;
  font-size: var(--skt-size); line-height: 2.0; white-space: pre-wrap;
  text-align:center; letter-spacing:.3px;
  background: linear-gradient(180deg, #fff, #ffe9b6 70%, #ffc857);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 2px 0 rgba(255,255,255,.06), 0 0 22px rgba(255,214,107,.25);
  filter: drop-shadow(0 4px 20px rgba(255,214,107,.06));
}
.trl{
  font-style: italic; white-space: pre-wrap; opacity:.97;
  font-size: var(--trl-size); text-align:center;
  color: rgba(255,255,255,.92);
}
.meaning, .context{ font-size: var(--body-size); line-height:1.9 }

/* animated gilded divider */
.divider{
  height:1px; border-radius:1px; margin:18px 0;
  background: linear-gradient(90deg, transparent, rgba(255,214,107,.7), transparent);
  position:relative; overflow:hidden;
}
.divider::after{
  content:""; position:absolute; left:-20%; top:-1px; bottom:-1px; width:40%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
  animation: dash 3.4s linear infinite;
  opacity:.7;
}
@keyframes dash { to { left:80% } }

/* ===== RESPONSIVE ===== */
@media (max-width: 560px){
  .wrap{ padding: 0 12px 92px }
  .bar{ border-radius:18px; padding:12px }
  input[type=number]{ width:5.8rem }
  .skt{ font-size: calc(var(--skt-size) + .18rem) }
  .meaning, .context{ font-size: 1.1rem }
}
@media (max-width: 360px){
  .title{ font-size: 1.06rem }
  .skt{ font-size: 1.6rem }
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Bhagavad Gita — One Verse</div>
    </header>

    <div class="bar">
      <label>Ch <input type="number" id="inCh" min="1" value="1"></label>
      <label>Vs <input type="number" id="inVs" min="1" value="1"></label>
      <button id="go" class="accent">Go</button>
      <button id="prev">◀</button>
      <button id="next">▶</button>
      <label>Trans
        <select id="translator">
          <option value="auto" selected>Auto</option>
          <option value="purohit">Purohit</option>
          <option value="siva">Sivananda</option>
          <option value="tej">Tejomayananda</option>
          <option value="gambir">Gambhirananda</option>
          <option value="chinmay">Chinmayananda</option>
          <option value="prabhupada">Prabhupada</option>
        </select>
      </label>
      <span class="status" id="status">API: vedicscriptures.github.io</span>
    </div>

    <div class="card">
      <h2 id="title">Chapter 1, Verse 1</h2>
      <div class="section">
        <div class="skt" id="slok">Loading…</div>
      </div>
      <div class="divider"></div>
      <div class="section">
        <div class="trl" id="trl"></div>
      </div>
      <div class="divider"></div>
      <div class="section meaning" id="meaning"></div>
      <div class="divider"></div>
      <div class="section context" id="context"></div>
    </div>
  </div>

<script>
const API_BASE = 'https://vedicscriptures.github.io';
let ch = 1, vs = 1;
let versesInChapter = {};

async function fetchJson(u){
  const res = await fetch(u);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function loadVerseCount(){
  const chapters = await fetchJson(`${API_BASE}/chapters`);
  chapters.forEach(c => versesInChapter[c.chapter_number] = c.verses_count);
}

// Fetch short context via Netlify function backed by Google Gemini API (server-side key)

async function getContextFromGoogle(verseText, meaningText){
  try {
    const cacheKey = `ctx:${ch}.${vs}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) return cached;

    const res = await fetch('/.netlify/functions/gitaContext', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chapter: ch, verse: vs,
        slok: verseText,
        transliteration: document.getElementById('trl').textContent,
        meaning: meaningText
      })
    });

    const data = await res.json();

    if (!res.ok || data?.error) {
      console.error('gitaContext error:', data?.error || res.status);
      return `Context unavailable (${data?.error || 'HTTP ' + res.status}).`;
    }

    const text = (data && data.context) ? String(data.context) : '';
    if (text) sessionStorage.setItem(cacheKey, text);
    return text || 'Context unavailable.';
  } catch (e) {
    console.error('gitaContext fetch failed:', e);
    return 'Context unavailable (network error).';
  }
}

async function load(){
  document.getElementById('title').textContent = `Chapter ${ch}, Verse ${vs}`;
  document.getElementById('slok').textContent = 'Loading…';
  document.getElementById('trl').textContent = '';
  document.getElementById('meaning').textContent = '';
  document.getElementById('context').textContent = '';
  try {
    const data = await fetchJson(`${API_BASE}/slok/${ch}/${vs}`);
    document.getElementById('slok').textContent = data.slok || '—';
    document.getElementById('trl').textContent = data.transliteration || '';
    const explicit = document.getElementById('translator').value;
    const prefer = explicit === 'auto' ? ['purohit','siva','tej','gambir','chinmay','prabhupada'] : [explicit];
    let meaning = 'Meaning unavailable for this verse.';
    for (const key of prefer) {
      if (data[key] && (data[key].et || data[key].hc || data[key].en)) {
        meaning = data[key].et || data[key].en || data[key].hc;
        break;
      }
    }
    document.getElementById('meaning').textContent = meaning;
    // AI Context (if function deployed)
    document.getElementById('context').textContent = 'Loading context…';
    const contextText = await getContextFromGoogle(data.slok, meaning);
    document.getElementById('context').textContent = contextText;
  } catch (e) {
    document.getElementById('slok').textContent = 'Failed to load verse.';
    document.getElementById('context').textContent = '';
  }
}

function goTo(){
  const c = parseInt(document.getElementById('inCh').value, 10) || 1;
  const v = parseInt(document.getElementById('inVs').value, 10) || 1;
  ch = Math.max(1, Math.min(18, c));
  vs = Math.max(1, Math.min(versesInChapter[ch] || 50, v));
  load();
}

document.getElementById('go').onclick = goTo;
document.getElementById('prev').onclick = () => {
  if (vs > 1) vs -= 1; else if (ch > 1) { ch -= 1; vs = versesInChapter[ch]; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};
document.getElementById('next').onclick = () => {
  if (vs < versesInChapter[ch]) vs += 1; else if (ch < 18) { ch += 1; vs = 1; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};

document.getElementById('translator').onchange = load;

window.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') goTo();
  if (e.key === 'ArrowLeft') document.getElementById('prev').click();
  if (e.key === 'ArrowRight') document.getElementById('next').click();
});

loadVerseCount().then(load);
</script>
</body>
</html>



