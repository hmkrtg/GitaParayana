<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gita — One Verse</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
<style>
 :root{
  /* Palette: midnight + temple gold */
  --bg:#070a17; --fg:#eef3ff; --muted:#a9b2d6; --card:#0e1430; --border:#1c2550;
  --accent:#ffd66b; --accent-2:#8ab6ff;
  --btn:#121a3b; --btn-border:#26306a; --shadow:0 22px 60px rgba(0,0,0,.55);
  --skt-size: 1.8rem; --trl-size: 1.06rem; --body-size: 1.06rem;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f6f7ff; --fg:#0b0f20; --muted:#59638a; --card:#ffffff; --border:#e2e6f6;
    --accent:#c18b00; --accent-2:#5f78ff;
    --btn:#f3f5ff; --btn-border:#d9def2; --shadow:0 22px 60px rgba(24,30,70,.12);
  }
}

/* Base + animated “spotlight” background */
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
html,body{height:100%}
body{
  font-family: Inter, system-ui, sans-serif; color:var(--fg); margin:0;
  background:
    radial-gradient(1200px 600px at 50% -380px, rgba(255,214,107,.10), transparent 60%),
    radial-gradient(900px 400px at 10% 120%, rgba(138,182,255,.08), transparent 60%),
    var(--bg);
  overflow-x:hidden; position:relative; isolation:isolate;
}
body::before{
  /* slow moving light sweep */
  content:""; position:fixed; inset:-40%;
  background: conic-gradient(from 120deg at 50% 50%,
    rgba(255,214,107,.12), rgba(138,182,255,.08), transparent 30%);
  mix-blend-mode: screen; filter: blur(60px); opacity:.35; z-index:-1;
  animation: sweep 18s linear infinite;
}
@keyframes sweep{ to{ transform: rotate(360deg) } }
@media (prefers-reduced-motion: reduce){ body::before{ animation:none } }

.wrap{ max-width:960px; margin: 18px auto; padding: 0 14px 80px }

/* Header */
header{ display:flex; align-items:center; justify-content:space-between; margin:6px 0 12px }
.title{ font-weight:800; letter-spacing:.3px; font-size:1.2rem }

/* Control bar → glassy, cinematic */
.bar{
  display:flex; flex-wrap:wrap; gap:.6rem; align-items:center;
  padding:12px; border-radius:18px; border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(18,26,59,.85), rgba(10,14,34,.75));
  box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,.06);
  position:sticky; top:8px; z-index:10; backdrop-filter: blur(12px);
}
label{ display:flex; align-items:center; gap:.45rem; color:var(--muted); font-size:.95rem }
input, select{
  padding:.75rem .9rem; border-radius:12px; border:1px solid var(--btn-border);
  background: linear-gradient(180deg, var(--btn), #0b112c);
  color:var(--fg); font-size:1rem; min-height:46px;
}
input[type=number]{ width:5rem }
button{
  padding:.78rem 1.1rem; border-radius:12px; border:1px solid var(--btn-border);
  background: linear-gradient(180deg, var(--btn), #0b112c);
  color:var(--fg); cursor:pointer; font-size:1rem; min-height:46px;
  transition: transform .06s ease, box-shadow .25s ease, filter .2s ease;
}
button:hover{ transform: translateY(-1px); filter: brightness(1.05) }
button:active{ transform: translateY(0) scale(.98) }
.accent{
  /* glowing gold action button */
  background: radial-gradient(80% 140% at 50% 0%, #ffe59b, #ffcb4e);
  color:#2b2100; border:0; font-weight:800; letter-spacing:.2px;
  box-shadow: 0 10px 24px rgba(255,203,78,.35), 0 0 0 1px rgba(255,203,78,.35) inset;
}
.status{ color:var(--muted); font-size:.92rem; margin-left:auto }

/* Verse card with halo + gilded dividers */
.card{
  position:relative; background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);
  border:1px solid var(--border); border-radius:20px; padding:22px 20px;
  box-shadow: var(--shadow);
}
.card::before{
  /* halo behind verse */
  content:""; position:absolute; inset:-2px; z-index:-1; border-radius:22px;
  background: radial-gradient(380px 220px at 50% 10%, rgba(255,214,107,.18), transparent 60%);
  filter: blur(10px);
}
h2{ margin:0 0 16px; font-size:1.02rem; font-weight:800; color:var(--muted) }

.section{ margin-top:14px; animation: rise .25s ease }
@keyframes rise{ from{ opacity:0; transform: translateY(6px) } to{ opacity:1; transform:none } }

.skt{
  font-family:"Noto Serif Devanagari", serif;
  font-size: var(--skt-size); line-height:1.9; white-space:pre-wrap;
  text-align:center; letter-spacing:.25px;
  text-shadow: 0 1px 0 rgba(255,255,255,.04), 0 0 22px rgba(255,214,107,.18);
}
.trl{
  font-style: italic; white-space:pre-wrap; opacity:.95;
  font-size: var(--trl-size); text-align:center;
}
.meaning, .context{ font-size: var(--body-size); line-height:1.85 }

/* gilded divider */
.divider{
  height:1px; border-radius:1px; margin:16px 0;
  background: linear-gradient(90deg, transparent, rgba(255,214,107,.65), transparent);
  opacity:.55;
}

/* Focus rings */
button:focus-visible, input:focus-visible, select:focus-visible{
  outline:2px solid var(--accent-2); outline-offset:2px;
}

/* Responsive */
@media (max-width: 560px){
  .wrap{ padding: 0 12px 84px }
  .bar{ border-radius:16px; padding:10px }
  input[type=number]{ width:5.6rem }
  .skt{ font-size: calc(var(--skt-size) + .12rem) }
  .meaning, .context{ font-size: 1.08rem }
}
@media (max-width: 360px){
  .title{ font-size: 1.05rem }
  .skt{ font-size: 1.45rem }
}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Bhagavad Gita — One Verse</div>
    </header>

    <div class="bar">
      <label>Ch <input type="number" id="inCh" min="1" value="1"></label>
      <label>Vs <input type="number" id="inVs" min="1" value="1"></label>
      <button id="go" class="accent">Go</button>
      <button id="prev">◀</button>
      <button id="next">▶</button>
      <label>Trans
        <select id="translator">
          <option value="auto" selected>Auto</option>
          <option value="purohit">Purohit</option>
          <option value="siva">Sivananda</option>
          <option value="tej">Tejomayananda</option>
          <option value="gambir">Gambhirananda</option>
          <option value="chinmay">Chinmayananda</option>
          <option value="prabhupada">Prabhupada</option>
        </select>
      </label>
      <span class="status" id="status">API: vedicscriptures.github.io</span>
    </div>

    <div class="card">
      <h2 id="title">Chapter 1, Verse 1</h2>
      <div class="section">
        <div class="skt" id="slok">Loading…</div>
      </div>
      <div class="divider"></div>
      <div class="section">
        <div class="trl" id="trl"></div>
      </div>
      <div class="divider"></div>
      <div class="section meaning" id="meaning"></div>
      <div class="divider"></div>
      <div class="section context" id="context"></div>
    </div>
  </div>

<script>
const API_BASE = 'https://vedicscriptures.github.io';
let ch = 1, vs = 1;
let versesInChapter = {};

async function fetchJson(u){
  const res = await fetch(u);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function loadVerseCount(){
  const chapters = await fetchJson(`${API_BASE}/chapters`);
  chapters.forEach(c => versesInChapter[c.chapter_number] = c.verses_count);
}

// Fetch short context via Netlify function backed by Google Gemini API (server-side key)

async function getContextFromGoogle(verseText, meaningText){
  try {
    const cacheKey = `ctx:${ch}.${vs}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) return cached;

    const res = await fetch('/.netlify/functions/gitaContext', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chapter: ch, verse: vs,
        slok: verseText,
        transliteration: document.getElementById('trl').textContent,
        meaning: meaningText
      })
    });

    const data = await res.json();

    if (!res.ok || data?.error) {
      console.error('gitaContext error:', data?.error || res.status);
      return `Context unavailable (${data?.error || 'HTTP ' + res.status}).`;
    }

    const text = (data && data.context) ? String(data.context) : '';
    if (text) sessionStorage.setItem(cacheKey, text);
    return text || 'Context unavailable.';
  } catch (e) {
    console.error('gitaContext fetch failed:', e);
    return 'Context unavailable (network error).';
  }
}

async function load(){
  document.getElementById('title').textContent = `Chapter ${ch}, Verse ${vs}`;
  document.getElementById('slok').textContent = 'Loading…';
  document.getElementById('trl').textContent = '';
  document.getElementById('meaning').textContent = '';
  document.getElementById('context').textContent = '';
  try {
    const data = await fetchJson(`${API_BASE}/slok/${ch}/${vs}`);
    document.getElementById('slok').textContent = data.slok || '—';
    document.getElementById('trl').textContent = data.transliteration || '';
    const explicit = document.getElementById('translator').value;
    const prefer = explicit === 'auto' ? ['purohit','siva','tej','gambir','chinmay','prabhupada'] : [explicit];
    let meaning = 'Meaning unavailable for this verse.';
    for (const key of prefer) {
      if (data[key] && (data[key].et || data[key].hc || data[key].en)) {
        meaning = data[key].et || data[key].en || data[key].hc;
        break;
      }
    }
    document.getElementById('meaning').textContent = meaning;
    // AI Context (if function deployed)
    document.getElementById('context').textContent = 'Loading context…';
    const contextText = await getContextFromGoogle(data.slok, meaning);
    document.getElementById('context').textContent = contextText;
  } catch (e) {
    document.getElementById('slok').textContent = 'Failed to load verse.';
    document.getElementById('context').textContent = '';
  }
}

function goTo(){
  const c = parseInt(document.getElementById('inCh').value, 10) || 1;
  const v = parseInt(document.getElementById('inVs').value, 10) || 1;
  ch = Math.max(1, Math.min(18, c));
  vs = Math.max(1, Math.min(versesInChapter[ch] || 50, v));
  load();
}

document.getElementById('go').onclick = goTo;
document.getElementById('prev').onclick = () => {
  if (vs > 1) vs -= 1; else if (ch > 1) { ch -= 1; vs = versesInChapter[ch]; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};
document.getElementById('next').onclick = () => {
  if (vs < versesInChapter[ch]) vs += 1; else if (ch < 18) { ch += 1; vs = 1; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};

document.getElementById('translator').onchange = load;

window.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') goTo();
  if (e.key === 'ArrowLeft') document.getElementById('prev').click();
  if (e.key === 'ArrowRight') document.getElementById('next').click();
});

loadVerseCount().then(load);
</script>
</body>
</html>


