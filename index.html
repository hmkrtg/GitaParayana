<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gita — One Verse</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
  /* colors */
  --bg: #f6f8ff; --fg:#0d1025; --muted:#5f6a86; --card:#ffffff; --border:#e6e9f5; --accent:#6b74ff;
  --btn:#f3f5ff; --btn-border:#d7dbef; --shadow: 0 14px 40px rgba(22, 30, 84, .10);
  /* type size controls */
  --skt-size: 1.5rem;
  --trl-size: 1.05rem;
  --body-size: 1.03rem;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b1020; --fg:#eaf0ff; --muted:#9aa6c7; --card:#111833; --border:#1d2748; --accent:#7aa2ff;
    --btn:#16224a; --btn-border:#24335f; --shadow: 0 18px 50px rgba(0,0,0,.45);
  }
}

/* base */
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
html, body { height:100% }
body {
  font-family: Inter, system-ui, sans-serif;
  background:
    radial-gradient(1200px 600px at 50% -400px, rgba(123,133,255,.18), transparent 60%),
    var(--bg);
  color:var(--fg); margin:0;
}
.wrap{ max-width: 900px; margin: 16px auto; padding: 0 14px 60px }

/* header */
header{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; margin: 8px 0 12px }
.title{ font-size: 1.15rem; font-weight: 700; letter-spacing:.2px }

/* control bar */
.bar{
  display:flex; flex-wrap:wrap; gap:.55rem; align-items:center;
  padding: 10px; background: var(--card); border:1px solid var(--border);
  border-radius:16px; box-shadow: var(--shadow);
  position: sticky; top: 8px; z-index: 5;
}
label{ display:flex; align-items:center; gap:.35rem; color:var(--muted); font-size:.95rem }
input, select{
  padding:.65rem .75rem; border-radius:12px; border:1px solid var(--btn-border);
  background:var(--btn); color:var(--fg); font-size: .98rem; min-height:44px;
}
input[type=number]{ width:4.8rem }
button{
  padding:.68rem 1rem; border-radius:12px; border:1px solid var(--btn-border);
  background:var(--btn); color:var(--fg); cursor:pointer; font-size:.98rem;
  transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
  min-height:44px;
}
button:hover{ transform: translateY(-1px) }
button:active{ transform: translateY(0) scale(.98) }
button:focus-visible, input:focus-visible, select:focus-visible{
  outline: 2px solid var(--accent); outline-offset: 2px;
}
.accent{
  background: linear-gradient(180deg, #8fb3ff, #6f95ff);
  color:#0b1020; border:0; font-weight:700;
  box-shadow: 0 6px 14px rgba(111,149,255,.35);
}
.status{ color:var(--muted); font-size:.9rem; margin-left:auto }

/* verse card */
.card{
  background:var(--card); border:1px solid var(--border); border-radius:18px;
  padding: 20px; box-shadow: var(--shadow); margin-top:14px;
}
h2{ margin:0 0 14px; font-size:1rem; font-weight:700; color:var(--muted) }

/* sections */
.section{ margin-top:12px; animation: fadeIn .25s ease }
.skt{
  font-family: "Noto Serif Devanagari", serif;
  font-size: var(--skt-size); line-height: 1.8; white-space: pre-wrap;
  text-align:center; letter-spacing:.2px;
}
.trl{
  font-style: italic; white-space: pre-wrap; opacity:.97;
  font-size: var(--trl-size); text-align:center;
}
.meaning, .context{ font-size: var(--body-size); line-height:1.75 }
.divider{ height:1px; background:var(--border); margin:14px 0; border-radius:1px }

/* micro-animations */
@keyframes fadeIn { from { opacity:0; transform: translateY(4px) } to { opacity:1; transform:none } }

/* responsive tweaks */
@media (max-width: 560px){
  .wrap{ padding: 0 12px 70px }
  .bar{ gap:.5rem; padding:10px; border-radius:14px }
  input[type=number]{ width:5.4rem }
  .skt{ font-size: calc(var(--skt-size) + .1rem) }
  .trl{ font-size: calc(var(--trl-size) + .02rem) }
  .meaning, .context{ font-size: 1.05rem }
}

/* ultra-compact mode for very small screens */
@media (max-width: 360px){
  .title{ font-size: 1rem }
  label{ font-size:.9rem }
  .skt{ font-size: 1.35rem }
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Bhagavad Gita — One Verse</div>
    </header>

    <div class="bar">
      <label>Ch <input type="number" id="inCh" min="1" value="1"></label>
      <label>Vs <input type="number" id="inVs" min="1" value="1"></label>
      <button id="go" class="accent">Go</button>
      <button id="prev">◀</button>
      <button id="next">▶</button>
      <label>Trans
        <select id="translator">
          <option value="auto" selected>Auto</option>
          <option value="purohit">Purohit</option>
          <option value="siva">Sivananda</option>
          <option value="tej">Tejomayananda</option>
          <option value="gambir">Gambhirananda</option>
          <option value="chinmay">Chinmayananda</option>
          <option value="prabhupada">Prabhupada</option>
        </select>
      </label>
      <span class="status" id="status">API: vedicscriptures.github.io</span>
    </div>

    <div class="card">
      <h2 id="title">Chapter 1, Verse 1</h2>
      <div class="section">
        <div class="skt" id="slok">Loading…</div>
      </div>
      <div class="divider"></div>
      <div class="section">
        <div class="trl" id="trl"></div>
      </div>
      <div class="divider"></div>
      <div class="section meaning" id="meaning"></div>
      <div class="divider"></div>
      <div class="section context" id="context"></div>
    </div>
  </div>

<script>
const API_BASE = 'https://vedicscriptures.github.io';
let ch = 1, vs = 1;
let versesInChapter = {};

async function fetchJson(u){
  const res = await fetch(u);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function loadVerseCount(){
  const chapters = await fetchJson(`${API_BASE}/chapters`);
  chapters.forEach(c => versesInChapter[c.chapter_number] = c.verses_count);
}

// Fetch short context via Netlify function backed by Google Gemini API (server-side key)

async function getContextFromGoogle(verseText, meaningText){
  try {
    const cacheKey = `ctx:${ch}.${vs}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) return cached;

    const res = await fetch('/.netlify/functions/gitaContext', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chapter: ch, verse: vs,
        slok: verseText,
        transliteration: document.getElementById('trl').textContent,
        meaning: meaningText
      })
    });

    const data = await res.json();

    if (!res.ok || data?.error) {
      console.error('gitaContext error:', data?.error || res.status);
      return `Context unavailable (${data?.error || 'HTTP ' + res.status}).`;
    }

    const text = (data && data.context) ? String(data.context) : '';
    if (text) sessionStorage.setItem(cacheKey, text);
    return text || 'Context unavailable.';
  } catch (e) {
    console.error('gitaContext fetch failed:', e);
    return 'Context unavailable (network error).';
  }
}

async function load(){
  document.getElementById('title').textContent = `Chapter ${ch}, Verse ${vs}`;
  document.getElementById('slok').textContent = 'Loading…';
  document.getElementById('trl').textContent = '';
  document.getElementById('meaning').textContent = '';
  document.getElementById('context').textContent = '';
  try {
    const data = await fetchJson(`${API_BASE}/slok/${ch}/${vs}`);
    document.getElementById('slok').textContent = data.slok || '—';
    document.getElementById('trl').textContent = data.transliteration || '';
    const explicit = document.getElementById('translator').value;
    const prefer = explicit === 'auto' ? ['purohit','siva','tej','gambir','chinmay','prabhupada'] : [explicit];
    let meaning = 'Meaning unavailable for this verse.';
    for (const key of prefer) {
      if (data[key] && (data[key].et || data[key].hc || data[key].en)) {
        meaning = data[key].et || data[key].en || data[key].hc;
        break;
      }
    }
    document.getElementById('meaning').textContent = meaning;
    // AI Context (if function deployed)
    document.getElementById('context').textContent = 'Loading context…';
    const contextText = await getContextFromGoogle(data.slok, meaning);
    document.getElementById('context').textContent = contextText;
  } catch (e) {
    document.getElementById('slok').textContent = 'Failed to load verse.';
    document.getElementById('context').textContent = '';
  }
}

function goTo(){
  const c = parseInt(document.getElementById('inCh').value, 10) || 1;
  const v = parseInt(document.getElementById('inVs').value, 10) || 1;
  ch = Math.max(1, Math.min(18, c));
  vs = Math.max(1, Math.min(versesInChapter[ch] || 50, v));
  load();
}

document.getElementById('go').onclick = goTo;
document.getElementById('prev').onclick = () => {
  if (vs > 1) vs -= 1; else if (ch > 1) { ch -= 1; vs = versesInChapter[ch]; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};
document.getElementById('next').onclick = () => {
  if (vs < versesInChapter[ch]) vs += 1; else if (ch < 18) { ch += 1; vs = 1; document.getElementById('inCh').value = ch; }
  document.getElementById('inVs').value = vs; load();
};

document.getElementById('translator').onchange = load;

window.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') goTo();
  if (e.key === 'ArrowLeft') document.getElementById('prev').click();
  if (e.key === 'ArrowRight') document.getElementById('next').click();
});

loadVerseCount().then(load);
</script>
</body>
</html>

